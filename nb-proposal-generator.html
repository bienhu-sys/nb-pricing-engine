<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#030712">
<title>NB Proposal Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<!-- jsPDF loaded at end of body -->
<style>
:root {
  --bg-deep: #030712;
  --bg-card: #0a0f1e;
  --bg-elevated: #111827;
  --border: #1e293b;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #475569;
  --accent-blue: #3b82f6;
  --accent-violet: #8b5cf6;
  --accent-gold: #c9a96e;
  --accent-emerald: #10b981;
  --accent-rose: #f43f5e;
  --gradient-brand: linear-gradient(135deg, #c9a96e, #d4b87a);
  --radius: 14px;
  --radius-sm: 10px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body {
  font-family:'Outfit',-apple-system,sans-serif; background:var(--bg-deep);
  color:var(--text-primary); min-height:100dvh; -webkit-font-smoothing:antialiased;
}
body::before {
  content:''; position:fixed; inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none; z-index:0;
}
.app { position:relative; z-index:1; max-width:520px; margin:0 auto; padding:20px 16px 60px; }

.header { display:flex; align-items:center; gap:14px; margin-bottom:28px; }
.header-logo {
  width:44px; height:44px; border-radius:12px; background:var(--gradient-brand);
  display:flex; align-items:center; justify-content:center;
  font-family:'JetBrains Mono',monospace; font-weight:700; font-size:16px;
  color:#0a1628; letter-spacing:-0.5px;
  box-shadow:0 4px 20px rgba(201,169,110,0.25);
}
.header h1 { font-size:17px; font-weight:700; letter-spacing:-0.3px; }
.header span { font-size:10px; color:var(--text-muted); letter-spacing:2.5px; text-transform:uppercase; display:block; }

.step-indicator { display:flex; gap:4px; margin-bottom:32px; }
.step-dot { flex:1; height:3px; border-radius:2px; background:var(--bg-elevated); transition:background 0.5s; }
.step-dot.active { background:var(--gradient-brand); }
.step-dot-label { font-size:9px; letter-spacing:1px; text-transform:uppercase; margin-top:6px; color:var(--text-muted); transition:color 0.3s; }
.step-dot-label.active { color:var(--text-secondary); }

.step { animation:stepIn 0.45s cubic-bezier(0.16,1,0.3,1); }
@keyframes stepIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

h2 { font-size:22px; font-weight:700; letter-spacing:-0.5px; margin-bottom:4px; }
.subtitle { font-size:13px; color:var(--text-muted); margin-bottom:28px; line-height:1.5; }

.field { margin-bottom:20px; }
.field-label {
  font-size:10px; color:var(--text-muted); letter-spacing:2px;
  text-transform:uppercase; display:block; margin-bottom:8px; font-weight:500;
}
.text-input, .select-input {
  width:100%; background:var(--bg-card); border:1.5px solid var(--border);
  border-radius:var(--radius-sm); padding:14px 16px; color:var(--text-primary);
  font-family:inherit; font-size:15px; outline:none; transition:border-color 0.2s;
}
.text-input:focus, .select-input:focus { border-color:var(--accent-gold); box-shadow:0 0 0 3px rgba(201,169,110,0.1); }
.text-input::placeholder { color:var(--text-muted); }
.select-input { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 16px center; }
.select-input option { background:var(--bg-card); color:var(--text-primary); }
textarea.text-input { resize:vertical; min-height:80px; line-height:1.6; }

.offer-cards { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.offer-card {
  padding:18px 14px; border-radius:var(--radius); cursor:pointer;
  border:1.5px solid var(--border); background:var(--bg-card); transition:all 0.25s;
  text-align:center;
}
.offer-card.active { border-color:var(--accent-gold); background:rgba(201,169,110,0.04); }
.offer-card-icon { font-size:28px; margin-bottom:8px; }
.offer-card-name { font-size:14px; font-weight:600; margin-bottom:2px; }
.offer-card.active .offer-card-name { color:var(--accent-gold); }
.offer-card-desc { font-size:11px; color:var(--text-muted); }

.diag-item { display:flex; gap:10px; align-items:flex-start; margin-bottom:10px; }
.diag-item .text-input { flex:1; }
.diag-remove {
  width:36px; height:44px; border-radius:8px; border:1px solid var(--border);
  background:var(--bg-card); color:var(--accent-rose); cursor:pointer;
  font-size:18px; display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:all 0.2s;
}
.diag-remove:hover { background:rgba(244,63,94,0.1); border-color:var(--accent-rose); }
.add-btn {
  width:100%; padding:12px; border-radius:var(--radius-sm); border:1.5px dashed var(--border);
  background:transparent; color:var(--text-muted); cursor:pointer; font-family:inherit;
  font-size:13px; transition:all 0.2s;
}
.add-btn:hover { border-color:var(--accent-gold); color:var(--accent-gold); }

.inclusion-chip {
  display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:var(--radius-sm);
  border:1.5px solid var(--border); background:var(--bg-card); cursor:pointer;
  margin-bottom:8px; transition:all 0.2s; user-select:none;
}
.inclusion-chip.active { border-color:var(--accent-gold); background:rgba(201,169,110,0.04); }
.inclusion-chip .check { color:var(--accent-gold); font-size:16px; opacity:0.3; }
.inclusion-chip.active .check { opacity:1; }
.inclusion-chip .label { flex:1; font-size:13px; color:var(--text-secondary); }
.inclusion-chip.active .label { color:var(--text-primary); }

.price-display {
  background:var(--bg-card); border-radius:var(--radius); padding:20px;
  border:1px solid var(--border); text-align:center; margin-bottom:20px;
}
.price-display .from { font-size:10px; color:var(--text-muted); letter-spacing:2px; margin-bottom:4px; }
.price-display .amount {
  font-family:'JetBrains Mono',monospace; font-size:32px; font-weight:700;
  background:linear-gradient(135deg,#c9a96e,#d4b87a); -webkit-background-clip:text;
  -webkit-text-fill-color:transparent; background-clip:text;
}

.summary-card {
  background:var(--bg-card); border-radius:var(--radius); padding:20px;
  border:1px solid var(--border); margin-bottom:14px;
}
.summary-card h3 { font-size:12px; color:var(--accent-gold); letter-spacing:1px; text-transform:uppercase; margin-bottom:12px; }
.summary-row { display:flex; justify-content:space-between; padding:6px 0; font-size:13px; }
.summary-row .label { color:var(--text-muted); }
.summary-row .value { color:var(--text-primary); font-weight:500; }

.btn-row { display:flex; gap:10px; margin-top:28px; flex-wrap:wrap; }
.btn {
  padding:14px 24px; border-radius:12px; font-family:inherit; font-size:14px;
  font-weight:600; cursor:pointer; transition:all 0.2s; border:none; letter-spacing:0.2px;
}
.btn:active { transform:scale(0.97); }
.btn-primary { background:var(--gradient-brand); color:#0a1628; box-shadow:0 4px 16px rgba(201,169,110,0.2); flex:1; }
.btn-primary:disabled { opacity:0.35; cursor:not-allowed; }
.btn-secondary { background:transparent; border:1.5px solid var(--border); color:var(--text-secondary); }
.btn-generate { background:linear-gradient(135deg,#059669,#10b981); color:#fff; flex:1; font-size:15px; padding:16px 24px; }

.generating { text-align:center; padding:40px 20px; }
.generating .spinner { width:48px; height:48px; border:3px solid var(--border); border-top-color:var(--accent-gold); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 20px; }
@keyframes spin { to{transform:rotate(360deg)} }

.info-note {
  background:rgba(201,169,110,0.06); border:1px solid rgba(201,169,110,0.15);
  border-radius:var(--radius-sm); padding:12px 14px; font-size:12px;
  color:var(--accent-gold); line-height:1.5; margin-bottom:20px;
}
</style>
</head>
<body>
<div class="app" id="app">
  <div style="display:flex;align-items:center;justify-content:center;min-height:80vh;flex-direction:column">
    <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#c9a96e,#d4b87a);display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:16px;color:#0a1628;margin-bottom:16px">NB</div>
    <div style="color:#94a3b8;font-size:14px">Chargement...</div>
  </div>
</div>

<script>
// jsPDF will be available after load
let jsPDF = null;

// ===== COMPANY DATA =====
const COMPANY = {
  name: "NB NEXT STEP",
  tagline: "Performance Cognitive & Coh√©sion d'√âquipe",
  address: "2 Impasse Doyen, 91710 Vert-le-Petit",
  associates: [
    { name: "Natacha Thelusme", role: "Pr√©sidente", tel: "06 78 81 31 45", email: "natacha@nb-nextstep.fr" },
    { name: "Indzembis Bienvenu", role: "Directeur G√©n√©ral", tel: "06 28 56 07 23", email: "bienvenu@nb-nextstep.fr" },
  ],
};

const DEFAULT_INCLUSIONS = {
  codir: [
    "Diagnostic initial et entretiens individuels avec chaque membre du CODIR",
    "Profiling LAB Profile complet de chaque participant avec restitution individuelle",
    "S√©minaires collectifs de coh√©sion et d'alignement strat√©gique",
    "Sessions de coaching individuel (DG et membres cl√©s)",
    "Ateliers pratiques de communication (PNL appliqu√©e au management)",
    "Rapport de synth√®se, recommandations et plan d'action post-mission",
    "Suivi post-programme (sessions collectives √† M+1 et M+3)",
  ],
  capcohesion: [
    "Diagnostic initial et audit de la dynamique d'√©quipe",
    "Ateliers collectifs de coh√©sion et communication",
    "Outils PNL adapt√©s au contexte du service public territorial",
    "Accompagnement QVT et bien-√™tre au travail",
    "Formation aux techniques de communication bienveillante",
    "Rapport de synth√®se et plan d'action personnalis√©",
    "Suivi post-programme (1 session collective √† M+1)",
  ],
};

// ===== STATE =====
const state = {
  step: 0,
  offerType: null, // 'codir' or 'capcohesion'
  clientName: "",
  clientContact: "",
  clientRole: "",
  duration: "6 mois",
  participants: "",
  price: "",
  diagnosticPoints: ["", "", ""],
  objectives: ["", "", ""],
  selectedInclusions: [],
  customInclusions: [],
  paymentTerms: "40% √† la signature, 30% √† mi-parcours, 30% √† la remise du rapport final. R√®glement par virement bancaire sous 30 jours.",
  notes: "",
};

// Read URL params from Pricing Engine
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get("client")) state.clientName = decodeURIComponent(urlParams.get("client"));
if (urlParams.get("price")) state.price = urlParams.get("price");
if (urlParams.get("segment")) {
  const seg = urlParams.get("segment");
  if (seg === "PME" || seg === "ETI / PME Mature") state.offerType = null;
  if (seg === "Scale-up / Tech" || seg === "Grand Groupe") state.offerType = "codir";
}

function formatPrice(n) {
  return new Intl.NumberFormat("fr-FR", { maximumFractionDigits: 0 }).format(n);
}

// ===== RENDER =====
function render() {
  const app = document.getElementById("app");
  const steps = ["Offre", "Client", "Diagnostic", "Prestations", "Tarif", "Aper√ßu"];

  let html = `
    <div class="header">
      <div class="header-logo">NB</div>
      <div>
        <h1>PROPOSAL GENERATOR</h1>
        <span>NB Next Step ‚Äî v1.0</span>
      </div>
    </div>
    <div class="step-indicator">
      ${steps.map((s, i) => `
        <div style="flex:1">
          <div class="step-dot ${i <= state.step ? 'active' : ''}"></div>
          <div class="step-dot-label ${i <= state.step ? 'active' : ''}">${s}</div>
        </div>
      `).join("")}
    </div>
  `;

  // STEP 0 ‚Äî Offer type
  if (state.step === 0) {
    html += `<div class="step">
      <h2>Type d'offre</h2>
      <p class="subtitle">S√©lectionnez le type de proposition √† g√©n√©rer</p>
      <div class="offer-cards">
        <div class="offer-card ${state.offerType === 'codir' ? 'active' : ''}" onclick="state.offerType='codir';state.selectedInclusions=DEFAULT_INCLUSIONS.codir.map((_,i)=>i);render()">
          <div class="offer-card-icon">üè¢</div>
          <div class="offer-card-name">CODIR</div>
          <div class="offer-card-desc">Entreprises<br>PME / ETI / Grands groupes</div>
        </div>
        <div class="offer-card ${state.offerType === 'capcohesion' ? 'active' : ''}" onclick="state.offerType='capcohesion';state.selectedInclusions=DEFAULT_INCLUSIONS.capcohesion.map((_,i)=>i);render()">
          <div class="offer-card-icon">üèõÔ∏è</div>
          <div class="offer-card-name">Cap Coh√©sion</div>
          <div class="offer-card-desc">Collectivit√©s<br>Mairies / Intercommunalit√©s</div>
        </div>
      </div>
      <div class="btn-row" style="justify-content:flex-end">
        <button class="btn btn-primary" ${!state.offerType?'disabled':''} onclick="state.step=1;render()">Suivant ‚Üí</button>
      </div>
    </div>`;
  }

  // STEP 1 ‚Äî Client info
  else if (state.step === 1) {
    html += `<div class="step">
      <h2>Informations client</h2>
      <p class="subtitle">Renseignez les coordonn√©es du client destinataire</p>
      ${state.price ? `
        <div class="info-note">
          üí∞ Prix pr√©-rempli depuis le Pricing Engine : <strong>${formatPrice(state.price)} ‚Ç¨ HT</strong>
        </div>
      ` : ''}
      <div class="field">
        <label class="field-label">Nom de l'entreprise / Collectivit√© *</label>
        <input class="text-input" id="clientName" value="${state.clientName}" placeholder="Ex: Brevo, Mairie de Vert-le-Petit...">
      </div>
      <div class="field">
        <label class="field-label">Nom du contact</label>
        <input class="text-input" id="clientContact" value="${state.clientContact}" placeholder="Ex: Jean Dupont">
      </div>
      <div class="field">
        <label class="field-label">Fonction du contact</label>
        <input class="text-input" id="clientRole" value="${state.clientRole}" placeholder="Ex: DRH, Maire, DG...">
      </div>
      <div class="field">
        <label class="field-label">Dur√©e de la mission</label>
        <select class="select-input" id="duration">
          ${["3 mois","4 mois","6 mois","9 mois","12 mois"].map(d => `<option value="${d}" ${state.duration===d?'selected':''}>${d}</option>`).join("")}
        </select>
      </div>
      <div class="field">
        <label class="field-label">Participants</label>
        <input class="text-input" id="participants" value="${state.participants}" placeholder="Ex: Comit√© de Direction (8 membres)">
      </div>
      <div class="btn-row" style="justify-content:space-between">
        <button class="btn btn-secondary" onclick="state.step=0;render()">‚Üê Retour</button>
        <button class="btn btn-primary" ${!state.clientName?'disabled':''} onclick="saveStep1();state.step=2;render()">Suivant ‚Üí</button>
      </div>
    </div>`;
  }

  // STEP 2 ‚Äî Diagnostic
  else if (state.step === 2) {
    html += `<div class="step">
      <h2>Diagnostic & Objectifs</h2>
      <p class="subtitle">Points identifi√©s lors de l'entretien et objectifs de la mission</p>
      
      <label class="field-label">Points de diagnostic</label>
      <div id="diagList">
        ${state.diagnosticPoints.map((p, i) => `
          <div class="diag-item">
            <input class="text-input" value="${p}" placeholder="Point de diagnostic ${i+1}..." onchange="state.diagnosticPoints[${i}]=this.value">
            ${state.diagnosticPoints.length > 1 ? `<button class="diag-remove" onclick="state.diagnosticPoints.splice(${i},1);render()">√ó</button>` : ''}
          </div>
        `).join("")}
      </div>
      <button class="add-btn" onclick="state.diagnosticPoints.push('');render()">+ Ajouter un point</button>

      <label class="field-label" style="margin-top:24px">Objectifs de la mission</label>
      <div id="objList">
        ${state.objectives.map((o, i) => `
          <div class="diag-item">
            <input class="text-input" value="${o}" placeholder="Objectif ${i+1}..." onchange="state.objectives[${i}]=this.value">
            ${state.objectives.length > 1 ? `<button class="diag-remove" onclick="state.objectives.splice(${i},1);render()">√ó</button>` : ''}
          </div>
        `).join("")}
      </div>
      <button class="add-btn" onclick="state.objectives.push('');render()">+ Ajouter un objectif</button>

      <div class="btn-row" style="justify-content:space-between;margin-top:28px">
        <button class="btn btn-secondary" onclick="state.step=1;render()">‚Üê Retour</button>
        <button class="btn btn-primary" onclick="state.step=3;render()">Suivant ‚Üí</button>
      </div>
    </div>`;
  }

  // STEP 3 ‚Äî Inclusions
  else if (state.step === 3) {
    const inclusions = DEFAULT_INCLUSIONS[state.offerType] || [];
    html += `<div class="step">
      <h2>D√©tail de la prestation</h2>
      <p class="subtitle">S√©lectionnez les √©l√©ments inclus dans votre proposition</p>
      
      ${inclusions.map((inc, i) => `
        <div class="inclusion-chip ${state.selectedInclusions.includes(i)?'active':''}" onclick="toggleInclusion(${i});render()">
          <span class="check">${state.selectedInclusions.includes(i) ? '‚úì' : '‚óã'}</span>
          <span class="label">${inc}</span>
        </div>
      `).join("")}

      <label class="field-label" style="margin-top:20px">Prestations personnalis√©es (optionnel)</label>
      ${state.customInclusions.map((ci, i) => `
        <div class="diag-item">
          <input class="text-input" value="${ci}" placeholder="Prestation personnalis√©e..." onchange="state.customInclusions[${i}]=this.value">
          <button class="diag-remove" onclick="state.customInclusions.splice(${i},1);render()">√ó</button>
        </div>
      `).join("")}
      <button class="add-btn" onclick="state.customInclusions.push('');render()">+ Ajouter une prestation</button>

      <div class="btn-row" style="justify-content:space-between;margin-top:28px">
        <button class="btn btn-secondary" onclick="state.step=2;render()">‚Üê Retour</button>
        <button class="btn btn-primary" onclick="state.step=4;render()">Suivant ‚Üí</button>
      </div>
    </div>`;
  }

  // STEP 4 ‚Äî Pricing
  else if (state.step === 4) {
    const p = parseInt(state.price) || 0;
    const tva = Math.round(p * 0.2);
    const ttc = p + tva;

    html += `<div class="step">
      <h2>Tarification</h2>
      <p class="subtitle">D√©finissez le montant et les modalit√©s de paiement</p>
      
      <div class="field">
        <label class="field-label">Montant HT (‚Ç¨) *</label>
        <input class="text-input" id="price" type="number" value="${state.price}" placeholder="Ex: 45000" style="font-family:'JetBrains Mono',monospace;font-size:20px;text-align:center">
      </div>

      ${p > 0 ? `
        <div class="price-display">
          <div class="from">MONTANT TOTAL</div>
          <div class="amount">${formatPrice(p)} ‚Ç¨ HT</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:8px">
            TVA 20% : ${formatPrice(tva)} ‚Ç¨ ‚Äî TTC : ${formatPrice(ttc)} ‚Ç¨
          </div>
        </div>
      ` : ''}

      <div class="field">
        <label class="field-label">Modalit√©s de r√®glement</label>
        <textarea class="text-input" id="paymentTerms">${state.paymentTerms}</textarea>
      </div>

      <div class="field">
        <label class="field-label">Notes internes (non affich√©es sur le PDF)</label>
        <textarea class="text-input" id="notes" placeholder="Notes pour votre usage...">${state.notes}</textarea>
      </div>

      <div class="btn-row" style="justify-content:space-between">
        <button class="btn btn-secondary" onclick="saveStep4();state.step=3;render()">‚Üê Retour</button>
        <button class="btn btn-primary" ${!state.price?'disabled':''} onclick="saveStep4();state.step=5;render()">Aper√ßu ‚Üí</button>
      </div>
    </div>`;
  }

  // STEP 5 ‚Äî Summary & Generate
  else if (state.step === 5) {
    const p = parseInt(state.price) || 0;
    const inclusions = DEFAULT_INCLUSIONS[state.offerType] || [];
    const selectedIncl = state.selectedInclusions.map(i => inclusions[i]).filter(Boolean);
    const allIncl = [...selectedIncl, ...state.customInclusions.filter(Boolean)];
    const diags = state.diagnosticPoints.filter(Boolean);
    const objs = state.objectives.filter(Boolean);

    html += `<div class="step">
      <h2>Aper√ßu & G√©n√©ration</h2>
      <p class="subtitle">V√©rifiez les informations avant de g√©n√©rer le PDF</p>

      <div class="summary-card">
        <h3>üìã Informations g√©n√©rales</h3>
        <div class="summary-row"><span class="label">Offre</span><span class="value">${state.offerType === 'codir' ? 'Accompagnement CODIR' : 'Cap Coh√©sion'}</span></div>
        <div class="summary-row"><span class="label">Client</span><span class="value">${state.clientName}</span></div>
        ${state.clientContact ? `<div class="summary-row"><span class="label">Contact</span><span class="value">${state.clientContact}${state.clientRole ? ' ‚Äî '+state.clientRole : ''}</span></div>` : ''}
        <div class="summary-row"><span class="label">Dur√©e</span><span class="value">${state.duration}</span></div>
        ${state.participants ? `<div class="summary-row"><span class="label">Participants</span><span class="value">${state.participants}</span></div>` : ''}
      </div>

      <div class="summary-card">
        <h3>üîç Diagnostic (${diags.length} points)</h3>
        ${diags.map(d => `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0;padding-left:16px;position:relative"><span style="position:absolute;left:0;color:var(--accent-gold)">‚Ä¢</span>${d}</div>`).join("")}
        ${diags.length === 0 ? '<div style="font-size:13px;color:var(--text-muted)">Aucun point renseign√©</div>' : ''}
      </div>

      <div class="summary-card">
        <h3>üéØ Objectifs (${objs.length})</h3>
        ${objs.map((o,i) => `<div style="font-size:13px;color:var(--text-secondary);padding:4px 0"><span style="color:var(--accent-gold);font-weight:600">0${i+1}</span> ${o}</div>`).join("")}
        ${objs.length === 0 ? '<div style="font-size:13px;color:var(--text-muted)">Aucun objectif renseign√©</div>' : ''}
      </div>

      <div class="summary-card">
        <h3>‚úì Prestations incluses (${allIncl.length})</h3>
        ${allIncl.map(inc => `<div style="font-size:12px;color:var(--text-secondary);padding:3px 0"><span style="color:var(--accent-gold)">‚úì</span> ${inc}</div>`).join("")}
      </div>

      <div class="summary-card">
        <h3>üí∞ Investissement</h3>
        <div style="text-align:center;padding:12px 0">
          <div style="font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700;color:var(--accent-gold)">${formatPrice(p)} ‚Ç¨ HT</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:4px">TVA 20% : ${formatPrice(Math.round(p*0.2))} ‚Ç¨ ‚Äî TTC : ${formatPrice(Math.round(p*1.2))} ‚Ç¨</div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn btn-secondary" onclick="state.step=4;render()">‚Üê Modifier</button>
        <button class="btn btn-generate" onclick="generatePDF()">üìÑ G√©n√©rer le PDF</button>
      </div>
    </div>`;
  }

  app.innerHTML = html;

  // Bind live inputs
  const ci = document.getElementById("clientName");
  if (ci) ci.addEventListener("input", e => { state.clientName = e.target.value; });
  const cc = document.getElementById("clientContact");
  if (cc) cc.addEventListener("input", e => { state.clientContact = e.target.value; });
  const cr = document.getElementById("clientRole");
  if (cr) cr.addEventListener("input", e => { state.clientRole = e.target.value; });
  const du = document.getElementById("duration");
  if (du) du.addEventListener("change", e => { state.duration = e.target.value; });
  const pa = document.getElementById("participants");
  if (pa) pa.addEventListener("input", e => { state.participants = e.target.value; });
  const pr = document.getElementById("price");
  if (pr) pr.addEventListener("input", e => { state.price = e.target.value; });
  const pt = document.getElementById("paymentTerms");
  if (pt) pt.addEventListener("input", e => { state.paymentTerms = e.target.value; });
  const no = document.getElementById("notes");
  if (no) no.addEventListener("input", e => { state.notes = e.target.value; });
}

function saveStep1() {
  const fields = ["clientName","clientContact","clientRole","participants"];
  fields.forEach(f => { const el = document.getElementById(f); if(el) state[f] = el.value; });
  const du = document.getElementById("duration"); if(du) state.duration = du.value;
}

function saveStep4() {
  const pr = document.getElementById("price"); if(pr) state.price = pr.value;
  const pt = document.getElementById("paymentTerms"); if(pt) state.paymentTerms = pt.value;
  const no = document.getElementById("notes"); if(no) state.notes = no.value;
}

function toggleInclusion(idx) {
  const i = state.selectedInclusions.indexOf(idx);
  if (i === -1) state.selectedInclusions.push(idx);
  else state.selectedInclusions.splice(i, 1);
}

// ===== PDF GENERATION =====
function generatePDF() {
  if (!window.jspdf) {
    alert("La librairie PDF est encore en cours de chargement. R√©essayez dans quelques secondes.");
    return;
  }
  if (!jsPDF) jsPDF = window.jspdf.jsPDF;
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  const W = 210, H = 297;
  const price = parseInt(state.price) || 0;
  const tva = Math.round(price * 0.2);
  const ttc = price + tva;
  const dateStr = new Date().toLocaleDateString("fr-FR");
  const ref = `NB-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${state.clientName.slice(0,3).toUpperCase()}`;
  const validityDate = new Date(Date.now() + 30*86400000).toLocaleDateString("fr-FR");
  const offerLabel = state.offerType === "codir" ? "Accompagnement CODIR" : "Cap Coh√©sion";
  const inclusions = DEFAULT_INCLUSIONS[state.offerType] || [];
  const selectedIncl = state.selectedInclusions.map(i => inclusions[i]).filter(Boolean);
  const allIncl = [...selectedIncl, ...state.customInclusions.filter(Boolean)];
  const diags = state.diagnosticPoints.filter(Boolean);
  const objs = state.objectives.filter(Boolean);

  // ===== COLORS =====
  const navy = [10, 22, 40];
  const gold = [201, 169, 110];
  const white = [255, 255, 255];
  const darkText = [26, 26, 46];
  const bodyText = [55, 65, 81];
  const mutedText = [107, 114, 128];
  const lightBg = [245, 245, 240];

  // ===== PAGE 1 ‚Äî COVER =====
  doc.setFillColor(...navy);
  doc.rect(0, 0, W, H, "F");

  // Gold top bar
  doc.setFillColor(...gold);
  doc.rect(0, 0, W, 4, "F");

  // Company name
  doc.setTextColor(...gold);
  doc.setFontSize(28);
  doc.setFont("helvetica", "bold");
  doc.text("NB NEXT STEP", W/2, 85, { align: "center" });

  // Tagline
  doc.setTextColor(136, 153, 170);
  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text(COMPANY.tagline, W/2, 94, { align: "center" });

  // Gold line
  doc.setDrawColor(...gold);
  doc.setLineWidth(0.5);
  doc.line(W/2 - 30, 102, W/2 + 30, 102);

  // Document title
  doc.setTextColor(...white);
  doc.setFontSize(22);
  doc.setFont("helvetica", "bold");
  doc.text("PROPOSITION COMMERCIALE", W/2, 125, { align: "center" });

  // Offer type
  doc.setTextColor(...gold);
  doc.setFontSize(14);
  doc.setFont("helvetica", "normal");
  doc.text(offerLabel, W/2, 137, { align: "center" });

  // Client box
  doc.setFillColor(15, 29, 53);
  doc.setDrawColor(...gold);
  doc.setLineWidth(0.5);
  doc.roundedRect(30, 155, W-60, 35, 3, 3, "FD");

  doc.setTextColor(136, 153, 170);
  doc.setFontSize(9);
  doc.text("PR√âPAR√â POUR", W/2, 165, { align: "center" });

  doc.setTextColor(...white);
  doc.setFontSize(18);
  doc.setFont("helvetica", "bold");
  doc.text(state.clientName, W/2, 176, { align: "center" });

  if (state.clientContact) {
    doc.setTextColor(136, 153, 170);
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const contactStr = state.clientContact + (state.clientRole ? ` ‚Äî ${state.clientRole}` : "");
    doc.text(contactStr, W/2, 184, { align: "center" });
  }

  // Date
  doc.setTextColor(102, 119, 136);
  doc.setFontSize(10);
  doc.text(`Date : ${dateStr}  |  R√©f : ${ref}`, W/2, 255, { align: "center" });
  doc.setFontSize(9);
  doc.text(`Proposition valable jusqu'au ${validityDate}`, W/2, 263, { align: "center" });

  // Bottom gold bar
  doc.setFillColor(...gold);
  doc.rect(0, H-3, W, 3, "F");

  // ===== HELPER FUNCTIONS =====
  function addHeader(pageNum) {
    doc.setDrawColor(...gold);
    doc.setLineWidth(0.5);
    doc.line(20, 12, W-20, 12);
    doc.setTextColor(...gold);
    doc.setFontSize(8);
    doc.setFont("helvetica", "bold");
    doc.text("NB NEXT STEP", 20, 10);
    doc.setTextColor(...mutedText);
    doc.setFont("helvetica", "normal");
    doc.text(`Page ${pageNum}`, W-20, 10, { align: "right" });
  }

  function addFooter() {
    doc.setDrawColor(224, 224, 224);
    doc.setLineWidth(0.3);
    doc.line(20, H-15, W-20, H-15);
    doc.setTextColor(...mutedText);
    doc.setFontSize(7);
    doc.text(COMPANY.address, W/2, H-11, { align: "center" });
    doc.text(`${COMPANY.associates[0].email} | ${COMPANY.associates[1].email}`, W/2, H-7, { align: "center" });
  }

  function sectionTitle(y, title, number) {
    doc.setFillColor(...gold);
    doc.rect(20, y-1, 2.5, 7, "F");
    doc.setTextColor(...darkText);
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    const prefix = number ? `${number}. ` : "";
    doc.text(prefix + title, 26, y+5);
    doc.setDrawColor(229, 231, 235);
    doc.setLineWidth(0.3);
    doc.line(20, y+9, W-20, y+9);
    return y + 16;
  }

  function wrapText(text, x, y, maxWidth, lineHeight) {
    doc.setFont("helvetica", "normal");
    const lines = doc.splitTextToSize(text, maxWidth);
    for (const line of lines) {
      if (y > H - 25) { return -1; }
      doc.text(line, x, y);
      y += lineHeight;
    }
    return y;
  }

  // ===== PAGE 2 ‚Äî DIAGNOSTIC =====
  doc.addPage();
  addHeader(2);
  addFooter();

  let y = 22;
  y = sectionTitle(y, "CONTEXTE & DIAGNOSTIC", "1");

  doc.setTextColor(...bodyText);
  doc.setFontSize(10);
  const introText = state.offerType === "codir"
    ? `Suite √† notre √©change avec ${state.clientName}, nous avons identifi√© les enjeux suivants au sein de votre Comit√© de Direction :`
    : `Suite √† notre √©change avec ${state.clientName}, nous avons identifi√© les enjeux suivants au sein de vos √©quipes :`;
  y = wrapText(introText, 20, y, W-40, 5);
  y += 6;

  for (const point of diags) {
    if (!point) continue;
    doc.setFillColor(...gold);
    doc.circle(23.5, y-1.5, 1.5, "F");
    doc.setTextColor(...bodyText);
    doc.setFontSize(10);
    y = wrapText(point, 28, y, W-48, 5);
    if (y === -1) break;
    y += 3;
  }

  y += 8;
  y = sectionTitle(y, "OBJECTIFS DE LA MISSION", "2");

  for (let i = 0; i < objs.length; i++) {
    if (!objs[i]) continue;
    doc.setTextColor(...gold);
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text(`0${i+1}`, 23, y);
    doc.setTextColor(...bodyText);
    doc.setFont("helvetica", "normal");
    y = wrapText(objs[i], 32, y, W-52, 5);
    if (y === -1) break;
    y += 4;
  }

  y += 8;
  y = sectionTitle(y, "NOTRE APPROCHE", "3");

  const approach = state.offerType === "codir"
    ? "Notre m√©thodologie s'appuie sur les outils de la Programmation Neuro-Linguistique (PNL) et le LAB Profile pour d√©coder les modes de fonctionnement de chaque membre du CODIR. Cette approche permet d'identifier les leviers de motivation, d'aligner les valeurs individuelles avec la vision collective, et de cr√©er une dynamique de coh√©sion durable."
    : "Le programme Cap Coh√©sion s'appuie sur les outils de la Programmation Neuro-Linguistique (PNL) et des techniques de communication avanc√©es pour renforcer la coh√©sion des √©quipes. Notre approche favorise l'√©mergence d'une dynamique collective positive, l'alignement des valeurs et l'am√©lioration de la qualit√© de vie au travail (QVT).";

  doc.setTextColor(...bodyText);
  doc.setFontSize(10);
  y = wrapText(approach, 20, y, W-40, 5);

  // ===== PAGE 3 ‚Äî PRICING =====
  doc.addPage();
  addHeader(3);
  addFooter();

  y = 22;
  y = sectionTitle(y, "INVESTISSEMENT", "4");
  y += 2;

  // Price box
  doc.setFillColor(...lightBg);
  doc.setDrawColor(...gold);
  doc.setLineWidth(0.8);
  doc.roundedRect(20, y, W-40, 45, 2, 2, "FD");

  doc.setTextColor(...darkText);
  doc.setFontSize(13);
  doc.setFont("helvetica", "bold");
  doc.text(offerLabel, 28, y+12);

  doc.setTextColor(...mutedText);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text(`Dur√©e : ${state.duration}`, 28, y+20);
  if (state.participants) doc.text(`Participants : ${state.participants}`, 28, y+27);

  doc.setTextColor(...gold);
  doc.setFontSize(26);
  doc.setFont("helvetica", "bold");
  doc.text(`${formatPrice(price)} ‚Ç¨`, W-28, y+16, { align: "right" });

  doc.setTextColor(...mutedText);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("HT", W-28, y+24, { align: "right" });
  doc.setFontSize(9);
  doc.text(`TVA 20% : ${formatPrice(tva)} ‚Ç¨ ‚Äî TTC : ${formatPrice(ttc)} ‚Ç¨`, W-28, y+32, { align: "right" });

  y += 55;

  // Inclusions
  y = sectionTitle(y, "D√âTAIL DE LA PRESTATION", "5");

  for (const inc of allIncl) {
    doc.setTextColor(...gold);
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text("‚úì", 23, y);
    doc.setTextColor(...bodyText);
    doc.setFont("helvetica", "normal");
    const newY = wrapText(inc, 30, y, W-50, 5);
    if (newY === -1) break;
    y = newY + 3;
  }

  y += 8;

  // Payment terms
  y = sectionTitle(y, "MODALIT√âS DE R√àGLEMENT", "6");
  doc.setTextColor(...bodyText);
  doc.setFontSize(10);
  wrapText(state.paymentTerms, 20, y, W-40, 5);

  // ===== PAGE 4 ‚Äî CGV =====
  doc.addPage();
  addHeader(4);
  addFooter();

  y = 22;
  y = sectionTitle(y, "CONDITIONS G√âN√âRALES", "7");

  const cgvSections = [
    ["Objet", `Les pr√©sentes CGV r√©gissent les relations contractuelles entre NB NEXT STEP, ${COMPANY.address}, et le Client d√©sign√© dans la proposition commerciale.`],
    ["Dur√©e et ex√©cution", "La mission d√©bute √† la date convenue apr√®s signature. Toute modification du calendrier doit faire l'objet d'un accord √©crit. NB NEXT STEP s'engage √† mettre en oeuvre tous les moyens n√©cessaires √† la bonne ex√©cution de la mission."],
    ["Tarifs et facturation", "Les tarifs sont en euros HT. La TVA sera ajout√©e au taux en vigueur. Les factures sont payables par virement bancaire sous 30 jours."],
    ["Retard de paiement", "Des p√©nalit√©s de retard seront appliqu√©es au taux de 3 fois le taux d'int√©r√™t l√©gal (art. L.441-10 Code de commerce). Indemnit√© forfaitaire de 40‚Ç¨ pour frais de recouvrement."],
    ["Annulation", "Annulation < 15 jours ouvr√©s : facturation de 50%. Annulation < 7 jours ouvr√©s : facturation de 100%. Reports possibles avec pr√©avis de 10 jours ouvr√©s."],
    ["Confidentialit√©", "NB NEXT STEP s'engage √† traiter de mani√®re confidentielle l'ensemble des informations communiqu√©es par le Client. Cette obligation s'√©tend au-del√† de la mission."],
    ["Propri√©t√© intellectuelle", "Les outils et m√©thodes restent la propri√©t√© de NB NEXT STEP. Le Client b√©n√©ficie d'un droit d'usage non exclusif des livrables."],
    ["Responsabilit√©", "NB NEXT STEP est soumise √† une obligation de moyens. Sa responsabilit√© ne saurait √™tre engag√©e en cas de force majeure."],
    ["Droit applicable", "Les pr√©sentes CGV sont soumises au droit fran√ßais. Tout litige rel√®ve des tribunaux du ressort du si√®ge social de NB NEXT STEP."],
  ];

  for (const [title, text] of cgvSections) {
    if (y > H - 40) {
      doc.addPage();
      addHeader(5);
      addFooter();
      y = 22;
    }
    doc.setTextColor(...darkText);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text(title, 20, y);
    y += 5;
    doc.setTextColor(...mutedText);
    doc.setFontSize(8.5);
    doc.setFont("helvetica", "normal");
    y = wrapText(text, 20, y, W-40, 4.5);
    y += 5;
  }

  // ===== LAST PAGE ‚Äî SIGNATURE =====
  doc.addPage();
  const sigPage = doc.internal.getNumberOfPages();
  addHeader(sigPage);
  addFooter();

  y = 22;
  y = sectionTitle(y, "ACCEPTATION & SIGNATURE", "8");

  doc.setTextColor(...bodyText);
  doc.setFontSize(10);
  y = wrapText("La signature de la pr√©sente proposition vaut acceptation des conditions d√©crites ci-dessus ainsi que des Conditions G√©n√©rales de Vente.", 20, y, W-40, 5);
  y += 15;

  // Two signature boxes
  const boxW = 75, boxH = 55, gap = 10;
  const xL = 20, xR = xL + boxW + gap;

  for (const [x, titleStr, nameStr] of [
    [xL, "Pour NB NEXT STEP", "Natacha Thelusme\nPr√©sidente"],
    [xR, "Pour le Client", `${state.clientName}\n${state.clientContact}`]
  ]) {
    doc.setFillColor(...lightBg);
    doc.setDrawColor(209, 213, 219);
    doc.setLineWidth(0.3);
    doc.roundedRect(x, y, boxW, boxH, 2, 2, "FD");

    doc.setTextColor(...gold);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text(titleStr, x+5, y+8);

    doc.setTextColor(...darkText);
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    const nameLines = nameStr.split("\n");
    nameLines.forEach((l, i) => doc.text(l, x+5, y+16 + i*5));

    doc.setTextColor(...mutedText);
    doc.setFontSize(8);
    doc.text("Signature :", x+5, y+boxH-12);
    doc.setDrawColor(209, 213, 219);
    doc.line(x+22, y+boxH-12, x+boxW-5, y+boxH-12);
    doc.text("Date :", x+5, y+boxH-5);
    doc.line(x+17, y+boxH-5, x+boxW-5, y+boxH-5);
  }

  y += boxH + 20;

  // Contacts
  doc.setTextColor(...gold);
  doc.setFontSize(10);
  doc.setFont("helvetica", "bold");
  doc.text("Vos interlocuteurs", W/2, y, { align: "center" });
  y += 10;

  for (const a of COMPANY.associates) {
    doc.setTextColor(...darkText);
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text(`${a.name} ‚Äî ${a.role}`, W/2, y, { align: "center" });
    doc.setTextColor(...mutedText);
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.text(`${a.tel}  |  ${a.email}`, W/2, y+6, { align: "center" });
    y += 16;
  }

  // Save
  const fileName = `Proposition_NB_${state.clientName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(fileName);
}

// Init
window.addEventListener('load', function() {
  try {
    render();
  } catch(e) {
    document.getElementById('app').innerHTML = '<div style="padding:40px;color:#f43f5e;text-align:center"><h2>Erreur de chargement</h2><p style="margin-top:12px;color:#94a3b8">'+e.message+'</p><button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:#c9a96e;color:#0a1628;border:none;border-radius:8px;font-size:14px;cursor:pointer">Recharger</button></div>';
  }
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
</body>
</html>
